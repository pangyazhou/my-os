;说明----------------------------------------------------------------------------
;


;--------------------------------------------------------------------------------
;类型命名原则
;		DA_		:struct descriptor Attribute
;		D 		:数据段
; 		C 		;代码段
; 		S  		;系统段
; 		R 		;只读
; 		RW		;读写
; 		A 		;已访问
; 		其他
;---------------------------------------------------------------------------------

;描述符类型
DA_32 			EQU 	4000H 	;32位段
DA_LIMIT_4K 	EQU 	8000H	;段界限粒度为4K

DA_DPL0 		EQU 	00H 	;DPL = 0
DA_DPL1 		EQU 	20H 	;DPL = 1
DA_DPL2 		EQU 	40H 	;DPL = 2
DA_DPL3			EQU 	60H 	;DPL = 3


;存储段描述符类型
DA_DR		EQU 		90h		;存在的只读数据段类型值
DA_DRW		EQU			92H		;存在的可读写数据段类型值
DA_DRWA 	EQU			93H 	;存在的已访问可读写数据段值类型
DA_C 		EQU 		98H		;存在的只执行代码段属性值
DA_CR 		EQU 		9AH 	;存在的可执行可读取代码段属性值
DA_CCO 		EQU 		9CH 	;存在的只执行一致性代码段属性值
DA_CCOR		EQU 		9EH 	;存在的可执行可读一致性代码段属性值

;系统段描述符类型
DA_LDT 		EQU 		82H 	;局部描述符表段类型值
DA_TaskGate EQU 		85H 	;任务门类型值
DA_386TSS 	EQU 		89H 	;可用386任务状态段类型值
DA_386CGate EQU 		8CH 	;386 调用门类型值
DA_386IGate EQU 		8EH 	;386 中断门类型值
DA_386TGate EQU 		8FH 	;386 陷阱门类型值


; 选择子图示:
;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9  ┃ 8  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
;         ┣━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━╋━━╋━━┻━━┫
;         ┃                                 描述符索引                     ┃ TI ┃   RPL   ┃
;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━┻━━━━━┛
;
; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
;
; TI(Table Indicator): 引用描述符表指示位
;	TI=0 指示从全局描述符表GDT中读取描述符；
;	TI=1 指示从局部描述符表LDT中读取描述符。
;
SA_RPL0		EQU	0	; ┓
SA_RPL1		EQU	1	; ┣ RPL
SA_RPL2		EQU	2	; ┃
SA_RPL3		EQU	3	; ┛

SA_TIG		EQU	0	; ┓TI
SA_TIL		EQU	4	; ┛


;----------------------------------------------------------------------------
; 分页机制使用的常量说明
;----------------------------------------------------------------------------
PG_P		EQU	1	; 页存在属性位
PG_RWR		EQU	0	; R/W 属性位值, 读/执行
PG_RWW		EQU	2	; R/W 属性位值, 读/写/执行
PG_USS		EQU	0	; U/S 属性位值, 系统级
PG_USU		EQU	4	; U/S 属性位值, 用户级
;----------------------------------------------------------------------------


;-----------------------------宏-------------------------------------------------

;描述符
;usage:	Descriptor Base, Limit, Attr
;		Base: 	dd
;		Limit:	dd (low 20 bits available)
;		Attr:	sw (lower 4 bits of high byte are always 0)
%macro	Descriptor 3 
		dw 			%2 & 0ffffh				;段界限2
		dw 			%1 & 0ffffh				;段基址1
		db			(%1 >> 16) & 0ffh 		;段基址2
		dw 			((%2 >> 8) & 0f00h) | (%3 & 0f0ffh);	;属性1 + 段界限2 + 属性2
		db 			(%1 >> 24) & 0ffh 		;段基址3
%endmacro	;共8个字节
;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

;门
;usage:	Gate Selector, Offset, DCount, Attr
;		Selector:	dw
; 		Offset:		dd
;		Dcount:		db
;		Attr:		db
%macro 	Gate 4
		dw 			%2 & 0ffffh							;偏移1
		dw 			%1									;选择子
		dw 			(%3 & 1fh) | ((%4 << 8) & 0ff00h)	;属性
		dw 			(%2 >> 16) & 0ffffh					;偏移2
%endmacro	;共8个字节
;^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^